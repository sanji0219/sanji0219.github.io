<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>人狼</title>
    <script defer src="/__/firebase/7.14.2/firebase-app.js"></script>
    <script defer src="/__/firebase/7.14.2/firebase-firestore.js"></script>    
    <script defer src="/__/firebase/init.js"></script>
    <link rel="stylesheet" href="style.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://kit.fontawesome.com/4731f42a74.js" crossorigin="anonymous"></script>
  </head>
  <body>
    <header>
      <a class="logos" href="index.html">
        <img src="src/logo.png" alt="">
        <h2>withUto</h2>
      </a>
      <div class="bar">
        <i class="fas fa-bars fa-3x"></i>
      </div>
    </header>
    <div class="ul">
      <a href="python.html"><p>Pythonのきほん</p></a>
      <a href="game.html"><p>動体視力ゲーム(笑)</p></a>
      <a href="timeline.html"><p>タイムライン</p></a>
      <a href="jinrou.html"><p>人狼(開発中)</p></a>
      <a href=""><p>開発中</p></a>
      <a href=""><p>開発中</p></a>
    </div>
    <main style="margin-top: 70px">
      <h3>人狼(開発中)</h3>
      <div class="form">
        <input type="text" id="server" placeholder="サーバー名">
        <input type="text" id="name" placeholder="ユーザー名">
        <input type="text" id="member" placeholder="遊ぶ人数">
        <button id="button">送信</button>
      </div>
      <div class="massages">
        <p class="error">脱落部分があるので修正してください。</p>
        <p class="announce">募集を締め切っています</p>
        <p id="atLeast"></p>
        <p class="sorry">あなたはこのサーバーで行われているゲームに参加していないようです。</p>
        <p class="entryCollect">エントリーが完了したのでしばらくお待ちください</p>
        <p class="entried"></p>
        <p class="position"></p>
        </div>
    </main>
    <script src="script/script.js"></script>
    <script>
      $(()=>{
        $(".error").hide();
        $(".announce").hide();
        $(".sorry").hide()
        $(".entryCollect").hide();
        var db = firebase.firestore()
        // var jinrouDB = db.collection("test").doc("jinrou");
        const serchServer=()=>{
          var loadServer=String($("#server").val());
          if(loadServer!=""){
            // jinrouDB.collection(loadServer).get().then((doc) => {
            db.collection("jinrou").doc(loadServer).get().then((doc) => {
            if (doc.exists) {
              // jinrouDB.collection(loadServer).get().then((doc)=>{
              db.collection("jinrou").doc(loadServer).get().then((doc)=>{
                $("#member").val(doc.data().member);
                console.log("同じサーバーのデータが見つかったのでメンバー数を表示します。")
                var collectMember=$("#member").val();
                db.collection("jinrou").doc("servers").collection(loadServer).onSnapshot((querySnapshot) => {
                  console.log("---------------------------------------")
                  var a=0;
                  querySnapshot.forEach((doc) => {
                  console.log(doc.data().name)
                  a+=1;
                  if(collectMember<=a){
                    console.log("メンバーが集まりました")
                    $(".announce").fadeIn();
                    $(".form").fadeOut();
                    $(".error").fadeOut();
                    $(".entryCollect").fadeOut();
                    $("#atLeast").fadeOut();
                    if($("#name").val()!=""){
                      var entryName=$("#name").val();
                      db.collection("jinrou").doc("servers").collection(loadServer).where("name", "==", entryName).get().then((querySnapshot) => {
                        $(".entried").prepend(`あなたは${entryName}という名前でこのサーバーに入室しています`)
                        querySnapshot.forEach((doc) => {
                          // console.log(doc.data().number)
                          db.collection("jinrou").doc("servers").collection(loadServer).where("number", "<=", doc.data().number).get().then((querySnapshot) => {
                            b=0;
                            const positionDecition=(totalMember,myNumber)=>{
                              if(totalMember<=7){
                                if(myNumber==1){
                                  $(".position").prepend(`${entryName}さん、あなたは人狼です`)
                                }else if(myNumber==2){
                                  $(".position").prepend(`${entryName}さん、あなたは占い師です`)
                                }else{
                                  $(".position").prepend(`${entryName}さん、あなたは村人です`)
                                }
                              }else{
                                if(myNumber==1 | myNumber==2){
                                  $(".position").prepend(`${entryName}さん、あなたは人狼です`)
                                }else if(myNumber==3){
                                  $(".position").prepend(`${entryName}さん、あなたは占い師です`)
                                }else{
                                  $(".position").prepend(`${entryName}さん、あなたは村人です`)
                                }
                              }
                            }
                            querySnapshot.forEach((doc) => {
                              b+=1
                            });
                            positionDecition(collectMember,b)
                          })
                        });
                      })
                    }else{
                      $(".sorry").fadeIn()
                    }
                  }
                  });
                  var c=collectMember-a;
                  console.log("あと"+c+"人")
                  var elem=document.getElementById('atLeast');
                  elem.innerHTML=`あと${c}人で募集が終了します`;
                });
              })
            } else {
              console.log("同じサーバーのデータはないです");
            }
          }).catch((error) => {
            console.log("Error getting document:", error);
          });
          }
        }
        $("#server").on("input",serchServer)
        $("#button").click(()=>{
          if($("#server").val()!="" & $("#name").val()!="" & $("#member").val()!=""){
            var server=String($("#server").val());
            var number=Math.floor(Math.random()*1000000);
            var member=String($("#member").val());
            var name=$("#name").val()
            db.collection("jinrou").doc("servers").collection(server).doc().set(
              {name:name,number:number,member:member}).then(()=> {});
            db.collection("jinrou").doc(server).set(
              {member:member}).then(()=>{})
            console.log("データを送信しました")
            $(".entryCollect").fadeIn();
            $(".form").fadeOut();
            $(".error").fadeOut();
          }else{
            console.log("全部の項目を埋めてください")
            $(".error").fadeIn();
          }
        })
      })
    </script>
  </body>
</html>